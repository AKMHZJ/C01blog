<div class="post-page" *ngIf="post" [ngClass]="isDark ? 'theme-dark' : 'theme-light'">
  <div class="container">
    
    <!-- 1. Header Area -->
    <header class="page-header">
      <button (click)="goBack()" class="back-link">
        <mat-icon>arrow_back</mat-icon> Back to all posts
      </button>

      <div class="meta-row">
        <span class="category-badge">{{ post.category }}</span>
        <span class="date-text">{{ post.date | date:'longDate' }}</span>
      </div>
    </header>

    <!-- 2. Author Section -->
    <div class="author-section">
      <div class="author-info">
        <img [src]="post.author?.avatar | imageUrl:'https://placehold.co/40'" alt="Author" class="author-avatar">
        <div class="author-text">
          <div class="author-name">{{ post.author?.displayName || post.author?.username }}</div>
          <div class="author-handle">@{{ post.author?.username }}</div>
        </div>
      </div>
      
      <button (click)="openReport()" class="report-btn" title="Report Post">
        <mat-icon>flag</mat-icon>
        <span>Report</span>
      </button>
    </div>

    <h1 class="post-title">{{ post.title }}</h1>

    <!-- 3. Hero Image -->
    <div class="hero-image-wrapper">
      <img [src]="post.image | imageUrl:'https://placehold.co/1200x600'" [alt]="post.title" class="hero-image">
    </div>

    <!-- 4. Action Bar -->
    <div class="action-bar">
      <button (click)="handleLike()" class="action-item" [class.active]="isLiked">
        <mat-icon>{{ isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
        <span>{{ post.likes.length || 0 }}</span>
      </button>
      <div class="action-item">
        <mat-icon>chat_bubble_outline</mat-icon>
        <span>{{ post.comments.length || 0 }}</span>
      </div>
    </div>

    <!-- 5. Content -->
    <div class="post-content">
      <markdown *ngFor="let paragraph of post.content" [data]="paragraph"></markdown>
    </div>

    <!-- 6. Comments Section -->
    <section class="comment-section">
      <h3 class="comments-header">Comments ({{ post.comments.length || 0 }})</h3>

      <div *ngIf="currentUser" class="comment-form-wrapper">
        <form (ngSubmit)="handleCommentSubmit()">
          <textarea [(ngModel)]="commentText" name="commentText" rows="3" class="comment-input" placeholder="Write a comment..."></textarea>
          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="!commentText.trim()">Post Comment</button>
          </div>
        </form>
      </div>

      <div class="comments-list">
        <div *ngFor="let comment of post.comments" class="comment-card">
          <img [src]="comment.author?.avatar | imageUrl:'https://placehold.co/40'" alt="Author" class="comment-avatar">
          
          <div class="comment-body">
            <div class="comment-header">
              <div class="comment-meta">
                <span class="author-name">{{ comment.author?.displayName || comment.author?.username }}</span>
                <span class="comment-date">{{ formatTimestamp(comment.timestamp) }}</span>
              </div>
              
              <div class="comment-actions" *ngIf="isOwnComment(comment) && editingCommentId !== comment.id">
                <button (click)="startEdit(comment)" class="icon-action">
                  <mat-icon>edit</mat-icon>
                </button>
                <button (click)="handleDeleteComment(comment.id)" class="icon-action delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            
            @if (editingCommentId && editingCommentId === comment.id) {
              <div class="edit-box">
                <textarea [(ngModel)]="editText" class="edit-input" rows="3"></textarea>
                <div class="edit-actions">
                  <button (click)="cancelEdit()" class="btn-text">Cancel</button>
                  <button (click)="saveEdit(comment.id)" class="btn-primary small">Save</button>
                </div>
              </div>
            } @else {
              <p class="comment-text">{{ comment.text }}</p>
            }
          </div>
        </div>
        <p *ngIf="!post.comments.length" class="no-comments">No comments yet. Be the first to share your thoughts!</p>
      </div>
    </section>

  </div>
</div>
