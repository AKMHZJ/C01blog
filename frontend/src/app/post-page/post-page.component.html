<div class="post-page" *ngIf="post" [ngClass]="isDark ? 'theme-dark' : 'theme-light'">
  <div class="container">
    
    <!-- 1. Header Area -->
    <header class="page-header">
      <button (click)="goBack()" class="back-link">
        <mat-icon>arrow_back</mat-icon> Back to all posts
      </button>

      <div class="meta-row">
        <span class="category-badge">{{ post.category }}</span>
        <span class="date-text">{{ post.date | date:'longDate' }}</span>
      </div>
    </header>

    <!-- 2. Author Section -->
    <div class="author-section">
      <div class="author-info">
        <img [src]="post.author?.avatar | imageUrl:'https://placehold.co/40'" alt="Author" class="author-avatar">
        <div class="author-text">
          <div class="author-name">{{ post.author?.displayName || post.author?.username }}</div>
          <div class="author-handle">@{{ post.author?.username }}</div>
        </div>
      </div>
      
      <button (click)="openReport()" class="report-btn" title="Report Post">
        <mat-icon>flag</mat-icon>
        <span>Report</span>
      </button>
    </div>

    <h1 class="post-title">{{ post.title }}</h1>

    <!-- 3. Media Carousel -->
    <div class="media-carousel mb-8" *ngIf="mediaToDisplay.length > 0">
      
      <!-- Backdrop Blur Layer -->
      <div class="backdrop-layer" *ngIf="!isVideo(mediaToDisplay[currentMediaIndex])">
        <img [src]="mediaToDisplay[currentMediaIndex] | imageUrl:'https://placehold.co/1200x600'" 
             class="backdrop-image">
      </div>
      <!-- Video Backdrop (optional, static or dark) -->
      <div class="backdrop-layer bg-black" *ngIf="isVideo(mediaToDisplay[currentMediaIndex])"></div>

      <!-- Current Media Item with Animation -->
      <!-- The animation triggers when currentMediaIndex changes. 
           ngFor ensures the element is destroyed/created for :enter/:leave animations -->
      <div class="media-wrapper" [@carouselAnimation]="currentMediaIndex">
        <ng-container *ngFor="let url of [mediaToDisplay[currentMediaIndex]]">
          <div class="media-inner-container">
            <ng-container *ngIf="isVideo(url); else imgTemplate">
              <video [src]="url | imageUrl" 
                     class="carousel-item shadow-2xl" controls preload="metadata"></video>
            </ng-container>
            <ng-template #imgTemplate>
              <img [src]="url | imageUrl:'https://placehold.co/1200x600'" 
                   [alt]="post.title" class="carousel-item shadow-2xl">
            </ng-template>
          </div>
        </ng-container>
      </div>

      <!-- Navigation Arrows (only if multiple items) -->
      <ng-container *ngIf="mediaToDisplay.length > 1">
        <button (click)="prevMedia()" 
                style="position: absolute; left: 1rem; top: 50%; z-index: 50; transform: translateY(-50%);"
                class="bg-white/10 hover:bg-white/20 text-white p-3 rounded-full backdrop-blur-md transition shadow-lg cursor-pointer border-none group">
          <mat-icon class="group-hover:-translate-x-0.5 transition-transform">chevron_left</mat-icon>
        </button>
        <button (click)="nextMedia()" 
                style="position: absolute; right: 1rem; top: 50%; z-index: 50; transform: translateY(-50%);"
                class="bg-white/10 hover:bg-white/20 text-white p-3 rounded-full backdrop-blur-md transition shadow-lg cursor-pointer border-none group">
          <mat-icon class="group-hover:translate-x-0.5 transition-transform">chevron_right</mat-icon>
        </button>
        
        <!-- Indicators -->
        <div style="position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); z-index: 50;" class="flex gap-2">
          <button *ngFor="let item of mediaToDisplay; let i = index" 
                  (click)="currentMediaIndex = i"
                  class="w-2.5 h-2.5 rounded-full transition-all shadow-sm border-none p-0 cursor-pointer"
                  [style.background-color]="i === currentMediaIndex ? 'white' : 'rgba(255,255,255,0.4)'"
                  [style.transform]="i === currentMediaIndex ? 'scale(1.2)' : 'scale(1)'">
          </button>
        </div>

        <!-- Counter -->
        <div style="position: absolute; top: 1rem; right: 1rem; z-index: 50;" 
             class="bg-black/50 text-white text-[10px] px-2 py-0.5 rounded backdrop-blur-sm font-sans uppercase tracking-wider">
          {{ currentMediaIndex + 1 }} / {{ mediaToDisplay.length }}
        </div>
      </ng-container>
    </div>

    <!-- 4. Action Bar -->
    <div class="action-bar">
      <button (click)="handleLike()" class="action-item" [class.active]="isLiked">
        <mat-icon>{{ isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
        <span>{{ post.likes.length || 0 }}</span>
      </button>
      <div class="action-item">
        <mat-icon>chat_bubble_outline</mat-icon>
        <span>{{ post.comments.length || 0 }}</span>
      </div>
    </div>

    <!-- 5. Content -->
    <div class="post-content">
      <markdown *ngFor="let paragraph of post.content" [data]="paragraph"></markdown>
    </div>

    <!-- 6. Comments Section -->
    <section class="comment-section">
      <h3 class="comments-header">Comments ({{ post.comments.length || 0 }})</h3>

      <div *ngIf="currentUser" class="comment-form-wrapper">
        <form (ngSubmit)="handleCommentSubmit()">
          <textarea [(ngModel)]="commentText" name="commentText" rows="3" class="comment-input" placeholder="Write a comment..."></textarea>
          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="!commentText.trim()">Post Comment</button>
          </div>
        </form>
      </div>

      <div class="comments-list">
        <div *ngFor="let comment of post.comments" class="comment-card">
          <img [src]="comment.author?.avatar | imageUrl:'https://placehold.co/40'" alt="Author" class="comment-avatar">
          
          <div class="comment-body">
            <div class="comment-header">
              <div class="comment-meta">
                <span class="author-name">{{ comment.author?.displayName || comment.author?.username }}</span>
                <span class="comment-date">{{ formatTimestamp(comment.timestamp) }}</span>
              </div>
              
              <div class="comment-actions" *ngIf="isOwnComment(comment) && editingCommentId !== comment.id">
                <button (click)="startEdit(comment)" class="icon-action">
                  <mat-icon>edit</mat-icon>
                </button>
                <button (click)="handleDeleteComment(comment.id)" class="icon-action delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            
            @if (editingCommentId && editingCommentId === comment.id) {
              <div class="edit-box">
                <textarea [(ngModel)]="editText" class="edit-input" rows="3"></textarea>
                <div class="edit-actions">
                  <button (click)="cancelEdit()" class="btn-text">Cancel</button>
                  <button (click)="saveEdit(comment.id)" class="btn-primary small">Save</button>
                </div>
              </div>
            } @else {
              <p class="comment-text">{{ comment.text }}</p>
            }
          </div>
        </div>
        <p *ngIf="!post.comments.length" class="no-comments">No comments yet. Be the first to share your thoughts!</p>
      </div>
    </section>

  </div>
</div>
